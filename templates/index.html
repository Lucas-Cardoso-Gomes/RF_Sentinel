<!DOCTYPE html>
<html lang="pt-BR" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFSentinel - Painel de Controle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; }
        .status-active { color: #22c55e; text-shadow: 0 0 8px #22c55e; }
        .status-stopped { color: #ef4444; text-shadow: 0 0 8px #ef4444; }
        #activity-log { height: 150px; background-color: #0c121e; border: 1px solid #374151; border-radius: 0.5rem; padding: 0.75rem; font-family: monospace; font-size: 0.8rem; overflow-y: scroll; white-space: pre-wrap; color: #9ca3af; }
    </style>
</head>

<body class="p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-100">üì° RFSentinel</h1>
            <p class="text-lg text-gray-400">Centro de Controle da Esta√ß√£o Terrestre</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-1 space-y-8">
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-200">Status do Hardware</h2>
                    <p id="hackrf-status-text" class="text-xl font-bold mt-1">Verificando...</p>
                </div>
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-semibold text-gray-200">Scanner de Sat√©lites</h2>
                            <p id="scanner-status-text" class="text-xl font-bold mt-1">Verificando...</p>
                        </div>
                        <button id="toggle-button" class="px-6 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">Ativar/Parar</button>
                    </div>
                </div>
                
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-200 mb-4">Captura Manual</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="capture-name" class="text-sm font-medium text-gray-400">Nome da Captura</label>
                            <input type="text" id="capture-name" placeholder="Ex: R√°dio local" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="capture-freq" class="text-sm font-medium text-gray-400">Frequ√™ncia (MHz)</label>
                            <input type="number" id="capture-freq" value="146.520" step="0.001" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="capture-duration" class="text-sm font-medium text-gray-400">Dura√ß√£o (segundos)</label>
                            <input type="number" id="capture-duration" value="30" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button id="manual-capture-button" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Gravar
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-8">
                 <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-200 mb-2">Pr√≥xima Captura Agendada</h2>
                    <p class="text-lg text-gray-400">Alvo: <span id="next-target" class="font-bold text-gray-200">Nenhum</span></p>
                    <p class="text-lg text-gray-400">Hor√°rio (UTC): <span id="next-time" class="font-bold text-gray-200">--:--:--</span></p>
                    <p class="text-2xl text-cyan-400 mt-2" id="next-countdown">Aguardando...</p>
                </div>
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-200 mb-4">Log de Atividades</h2>
                    <div id="activity-log"></div>
                </div>

                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <h2 class="text-2xl font-semibold text-gray-200">Waterfall Interativo</h2>
                        <div class="flex items-center space-x-4">
                            <div>
                                <label for="wf-freq" class="text-sm text-gray-400">Freq. (MHz)</label>
                                <input type="number" id="wf-freq" value="101.1" step="0.1" class="bg-gray-700 text-white rounded px-2 py-1 w-24">
                            </div>
                            <div>
                                <label for="wf-gain" class="text-sm text-gray-400">Ganho</label>
                                <input type="range" id="wf-gain" min="0" max="40" step="1" value="32" class="align-middle">
                                <span id="wf-gain-label" class="text-sm text-gray-300">32</span>
                            </div>
                            <button id="wf-update" class="px-4 py-1 bg-indigo-600 hover:bg-indigo-700 rounded text-white font-semibold">Aplicar</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-[50px_1fr] gap-x-2">
                        <canvas id="power-axis" class="w-full h-64"></canvas>
                        <canvas id="waterfall-canvas" class="w-full h-64 bg-black rounded-sm"></canvas>
                        <div></div> <canvas id="freq-axis" class="w-full h-6"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 bg-gray-800 rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-200 mb-4">Hist√≥rico de Capturas</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-gray-600 text-gray-400">
                                <th class="p-3">Alvo</th>
                                <th class="p-3">Frequ√™ncia</th>
                                <th class="p-3">Timestamp</th>
                                <th class="p-3">√Åudio</th>
                                <th class="p-3">Imagem</th>
                                <th class="p-3">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="signals-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer class="text-center mt-8 text-gray-500">
            <p>Desenvolvido por Lucas Cardoso Gomes.</p>
        </footer>
    </div>

    <script>
        const RFSentinelApp = {
            elements: {
                hackrfStatusText: document.getElementById('hackrf-status-text'),
                scannerStatusText: document.getElementById('scanner-status-text'),
                toggleButton: document.getElementById('toggle-button'),
                signalsTable: document.getElementById('signals-table'),
                activityLog: document.getElementById('activity-log'),
                nextTarget: document.getElementById('next-target'),
                nextTime: document.getElementById('next-time'),
                nextCountdown: document.getElementById('next-countdown'),
                manualCaptureButton: document.getElementById('manual-capture-button'),
                captureNameInput: document.getElementById('capture-name'),
                captureFreqInput: document.getElementById('capture-freq'),
                captureDurationInput: document.getElementById('capture-duration'),
                wfCanvas: document.getElementById('waterfall-canvas'),
                wfCtx: document.getElementById('waterfall-canvas').getContext('2d'),
                wfFreqAxisCanvas: document.getElementById('freq-axis'),
                wfFreqCtx: document.getElementById('freq-axis').getContext('2d'),
                wfPowerAxisCanvas: document.getElementById('power-axis'),
                wfPowerCtx: document.getElementById('power-axis').getContext('2d'),
                wfFreqInput: document.getElementById('wf-freq'),
                wfGainInput: document.getElementById('wf-gain'),
                wfGainLabel: document.getElementById('wf-gain-label'),
                wfUpdateButton: document.getElementById('wf-update'),
            },
            state: {
                countdownInterval: null,
                waterfall: {
                    ws: null,
                    tempCanvas: document.createElement('canvas'),
                    metadata: { sample_rate: 2.4e6, center_freq: 101.1e6 }
                }
            },
            
            init() {
                this.elements.toggleButton.addEventListener('click', () => this.api.toggleScanner());
                this.elements.manualCaptureButton.addEventListener('click', () => this.api.startManualCapture());
                this.elements.wfUpdateButton.addEventListener('click', () => this.waterfall.updateSettings());
                this.elements.wfGainInput.addEventListener('input', () => {
                    this.elements.wfGainLabel.textContent = this.elements.wfGainInput.value;
                });
                
                window.addEventListener('resize', () => this.waterfall.resize());
                
                this.updateLoop();
                this.waterfall.init();
            },

            updateLoop() {
                this.api.fetchStatus();
                this.api.fetchSignals();
                setInterval(() => {
                    this.api.fetchStatus();
                }, 2000);
                setInterval(() => {
                    this.api.fetchSignals();
                }, 10000);
            },
            
            api: {
                async fetchStatus() {
                    try {
                        const response = await fetch('/api/status');
                        const data = await response.json();
                        RFSentinelApp.ui.renderStatus(data);
                    } catch (error) { console.error('Erro ao buscar status:', error); }
                },
                async fetchSignals() {
                    try {
                        const response = await fetch('/api/signals');
                        const signals = await response.json();
                        RFSentinelApp.ui.renderSignals(signals);
                    } catch (error) { console.error('Erro ao buscar sinais:', error); }
                },
                async toggleScanner() { await fetch('/scanner/toggle', { method: 'POST' }); },
                async startManualCapture() {
                    RFSentinelApp.elements.manualCaptureButton.disabled = true;
                    try {
                        const response = await fetch('/api/capture/manual', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: RFSentinelApp.elements.captureNameInput.value || 'ManualCapture',
                                frequency_mhz: RFSentinelApp.elements.captureFreqInput.value,
                                duration_sec: RFSentinelApp.elements.captureDurationInput.value
                            })
                        });
                        if (!response.ok) alert(`Erro: ${(await response.json()).error}`);
                    } catch (e) {
                        alert('Falha ao iniciar captura.');
                        RFSentinelApp.elements.manualCaptureButton.disabled = false;
                    }
                }
            },
            
            ui: {
                renderStatus(data) {
                    const { elements } = RFSentinelApp;
                    elements.scannerStatusText.textContent = data.scanner_status;
                    elements.scannerStatusText.className = `text-xl font-bold mt-1 ${data.scanner_status === 'Ativo' ? 'status-active' : 'status-stopped'}`;
                    elements.hackrfStatusText.textContent = data.hackrf_status.status_text;
                    elements.hackrfStatusText.className = `text-xl font-bold mt-1 ${data.hackrf_status.connected ? 'status-active' : 'status-stopped'}`;
                    if(data.scheduler_log) this.renderLogs(data.scheduler_log);

                    if(data.next_pass) {
                        const pass = data.next_pass;
                        elements.nextTarget.textContent = pass.name;
                        const startTime = new Date(pass.start_utc);
                        elements.nextTime.textContent = startTime.toUTCString().substring(5, 25);
                        this.updateCountdown(startTime);
                    } else {
                        elements.nextTarget.textContent = 'Nenhum';
                        elements.nextTime.textContent = '--:--:--';
                        elements.nextCountdown.textContent = 'Aguardando...';
                        clearInterval(RFSentinelApp.state.countdownInterval);
                    }

                    const btn = elements.manualCaptureButton;
                    const isCapturing = data.manual_capture_active;
                    btn.disabled = isCapturing;
                    btn.textContent = isCapturing ? 'Gravando...' : 'Gravar';
                    const [removeBg, addBg] = isCapturing ? ['bg-green-600', 'hover:bg-green-700', 'bg-red-600', 'hover:bg-red-700'] : ['bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700'];
                    btn.classList.remove(removeBg, addBg.split(' ')[1]);
                    btn.classList.add(addBg.split(' ')[0], addBg.split(' ')[1]);
                },
                
                renderSignals(signals) {
                    const { signalsTable } = RFSentinelApp.elements;
                    signalsTable.innerHTML = '';
                    if (!signals || signals.length === 0) {
                        signalsTable.innerHTML = '<tr><td colspan="6" class="text-center p-4">Nenhuma captura registrada ainda.</td></tr>';
                        return;
                    }

                    signals.forEach(signal => {
                        const freqMhz = (signal.frequency / 1000000).toFixed(3);
                        let imageCell = '<td class="p-3">N/A</td>';
                        
                        if (signal.filepath && signal.filepath.toLowerCase().includes("noaa")) {
                            const base_filename = signal.filepath.split(/[\\\/]/).pop().replace('.wav', '.png');
                            const image_path = `captures/images/${base_filename}`;
                            imageCell = `<td class="p-3"><a href="/${image_path}" target="_blank" title="Ver imagem decodificada"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-400 hover:text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></a></td>`;
                        }

                        const row = `
                            <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                <td class="p-3">${signal.target}</td>
                                <td class="p-3">${freqMhz} MHz</td>
                                <td class="p-3">${(signal.timestamp || '').replace('_', ' ')}</td>
                                <td class="p-3 font-mono"><a href="/${signal.filepath}" download class="text-blue-400 hover:underline">${signal.filepath.split(/[\\\/]/).pop()}</a></td>
                                ${imageCell}
                                <td class="p-3"><a href="/analysis?id=${signal.id}" target="_blank" class="text-indigo-400 hover:underline">Analisar</a></td>
                            </tr>
                        `;
                        signalsTable.innerHTML += row;
                    });
                },
                
                renderLogs(logs) {
                    const logColors = {'INFO': 'text-gray-400', 'SUCCESS': 'text-green-400', 'WARN': 'text-yellow-400', 'ERROR': 'text-red-400', 'DEBUG': 'text-purple-400'};
                    RFSentinelApp.elements.activityLog.innerHTML = logs.map(log => 
                        `<span class="${logColors[log.level] || 'text-gray-400'}">[${log.timestamp}] ${log.message}</span>`
                    ).join('<br>');
                    RFSentinelApp.elements.activityLog.scrollTop = RFSentinelApp.elements.activityLog.scrollHeight;
                },

                updateCountdown(targetDate) {
                    clearInterval(RFSentinelApp.state.countdownInterval);
                    RFSentinelApp.state.countdownInterval = setInterval(() => {
                        const diff = targetDate - new Date();
                        if (diff <= 0) {
                            RFSentinelApp.elements.nextCountdown.textContent = "Em andamento...";
                            clearInterval(RFSentinelApp.state.countdownInterval);
                            return;
                        }
                        const h = Math.floor(diff / 3.6e6);
                        const m = Math.floor((diff % 3.6e6) / 6e4);
                        const s = Math.floor((diff % 6e4) / 1000);
                        RFSentinelApp.elements.nextCountdown.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                    }, 1000);
                }
            },
            
            waterfall: {
                init() {
                    this.state = RFSentinelApp.state.waterfall;
                    this.elements = RFSentinelApp.elements;
                    this.state.tempCtx = this.state.tempCanvas.getContext('2d');
                    this.resize();
                    this.drawPowerAxis();
                    this.connect();
                },
                resize() {
                    [this.elements.wfCanvas, this.elements.wfFreqAxisCanvas, this.elements.wfPowerAxisCanvas, this.state.tempCanvas].forEach(c => {
                        c.width = c.offsetWidth;
                        c.height = c.offsetHeight;
                    });
                    this.drawPowerAxis();
                    this.drawFreqAxis();
                },
                connect() {
                    if (this.state.ws && this.state.ws.readyState !== WebSocket.CLOSED) this.state.ws.close();
                    this.state.ws = new WebSocket(`ws://${window.location.host}/ws/waterfall`);
                    this.state.ws.onopen = () => console.log("WebSocket conectado.");
                    this.state.ws.onmessage = (event) => {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'metadata') {
                            Object.assign(this.state.metadata, msg);
                            this.drawFreqAxis();
                        } else if (msg.type === 'fft_data') {
                            this.draw(msg.data);
                        }
                    };
                    this.state.ws.onclose = (event) => {
                        const message = event.code === 1012 ? 'SDR em uso. Reconectando...' : 'Conex√£o Perdida. Reconectando...';
                        const color = event.code === 1012 ? 'orange' : 'red';
                        this.elements.wfCtx.fillStyle = color;
                        this.elements.wfCtx.fillText(message, this.elements.wfCanvas.width / 2, this.elements.wfCanvas.height / 2);
                        setTimeout(() => this.connect(), event.code === 1012 ? 15000 : 5000);
                    };
                },
                draw(data) {
                    const { wfCtx, wfCanvas } = this.elements;
                    const { tempCtx, tempCanvas } = this.state;
                    tempCtx.drawImage(wfCanvas, 0, 0);
                    wfCtx.clearRect(0, 0, wfCanvas.width, wfCanvas.height);
                    wfCtx.drawImage(tempCanvas, 0, 1);
                    const segmentWidth = wfCanvas.width / data.length;
                    const getColor = (v) => `hsl(${(1 - Math.max(0, Math.min(1, (v - -80) / 60))) * 240}, 100%, 50%)`;
                    for (let i = 0; i < data.length; i++) {
                        wfCtx.fillStyle = getColor(data[i]);
                        wfCtx.fillRect(i * segmentWidth, 0, Math.ceil(segmentWidth), 1);
                    }
                },
                drawFreqAxis() {
                    const { wfFreqCtx, wfFreqAxisCanvas } = this.elements;
                    const { metadata } = this.state;
                    wfFreqCtx.clearRect(0, 0, wfFreqAxisCanvas.width, wfFreqAxisCanvas.height);
                    wfFreqCtx.fillStyle = '#9ca3af';
                    wfFreqCtx.font = '10px monospace';
                    const startFreq = (metadata.center_freq - metadata.sample_rate / 2) / 1e6;
                    const endFreq = (metadata.center_freq + metadata.sample_rate / 2) / 1e6;
                    for (let i = 0; i <= 10; i++) {
                        const freq = startFreq + (endFreq - startFreq) * (i / 10);
                        const x = (wfFreqAxisCanvas.width / 10) * i;
                        wfFreqCtx.fillText(`${freq.toFixed(1)}`, x, 10);
                    }
                },
                drawPowerAxis() {
                    const { wfPowerCtx, wfPowerAxisCanvas } = this.elements;
                    wfPowerCtx.clearRect(0, 0, wfPowerAxisCanvas.width, wfPowerAxisCanvas.height);
                    wfPowerCtx.fillStyle = '#9ca3af';
                    wfPowerCtx.font = '10px monospace';
                    const minDb = -80, maxDb = -20;
                    for (let i = 0; i <= 10; i++) {
                        const db = maxDb - (maxDb - minDb) * (i / 10);
                        const y = (wfPowerAxisCanvas.height / 10) * i;
                        wfPowerCtx.fillText(`${db.toFixed(0)}dB`, 5, y + 10);
                    }
                },
                updateSettings() {
                    const { wfFreqInput, wfGainInput } = RFSentinelApp.elements;
                    const { ws } = this.state;
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ 
                            frequency: parseFloat(wfFreqInput.value) * 1e6, 
                            gain: parseInt(wfGainInput.value) 
                        }));
                    }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => RFSentinelApp.init());
    </script>
</body>
</html>